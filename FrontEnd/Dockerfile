# 1ï¸âƒ£ Node.js 20 ë²„ì „ ê¸°ë°˜ìœ¼ë¡œ ë¹Œë“œ
FROM node:20.10.0 AS build
WORKDIR /app

# Corepack í™œì„±í™” ë° Yarn ìµœì‹  ë²„ì „ ì ìš©
RUN corepack enable
RUN yarn set version berry  # ğŸ”¥ Yarn Berry(PnP) ë°©ì‹ ìœ ì§€

# ğŸ“Œ PnP ì‹¤í–‰ì„ ìœ„í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NODE_OPTIONS="--require .pnp.cjs"

# 3ï¸âƒ£ íŒ¨í‚¤ì§€ ê´€ë ¨ íŒŒì¼ ë³µì‚¬ ë° ì„¤ì •
COPY package.json yarn.lock ./

# ğŸ“Œ `.pnp.cjs`ê°€ ì •ìƒ ìƒì„±ë˜ë„ë¡ `yarn install`
RUN yarn install --immutable

# 4ï¸âƒ£ TypeScript íŒ¨í‚¤ì§€ í™•ì¸ (ì—†ìœ¼ë©´ ì„¤ì¹˜)
RUN yarn why typescript || yarn add --dev typescript

# ğŸ”¥ `.pnp.cjs` ê°•ì œ ì‹¤í–‰ (í•„ìˆ˜)
RUN node -r ./.pnp.cjs -e "console.log('PnP ë¡œë“œë¨')"

# 5ï¸âƒ£ `vite.config.ts` ìˆ˜ì • (ë¹Œë“œ í´ë” í™•ì¸)
RUN echo 'export default { build: { outDir: "dist", emptyOutDir: true } }' > vite.config.ts

# 6ï¸âƒ£ TypeScript ì˜¤ë¥˜ ë¬´ì‹œí•˜ë©´ì„œ ë¹Œë“œ ì§„í–‰
RUN yarn build --skipLibCheck --noEmitOnError false || true
# ğŸ” ë¹Œë“œ ê²°ê³¼ í™•ì¸ (ë””ë²„ê¹…)
RUN ls -al /app/ && ls -al /app/dist/ || echo "âš ï¸ ë¹Œë“œëœ dist í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"
RUN ls -al /app/ && ls -al /app/build/ || echo "âš ï¸ ë¹Œë“œëœ build í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"

# 7ï¸âƒ£ Nginxê°€ ì‚¬ìš©í•  ë¹Œë“œ ë””ë ‰í† ë¦¬ ì„¤ì • (Nginx ì„¤ì •ê³¼ ì¼ì¹˜!)
RUN mkdir -p /home/ubuntu/frontend_build
RUN cp -r /app/dist/* /home/ubuntu/frontend_build

# 8ï¸âƒ£ Nginx ì»¨í…Œì´ë„ˆì—ì„œ ì‚¬ìš©í•  ë¹Œë“œ í´ë” ì§€ì •
VOLUME /home/ubuntu/frontend_build
