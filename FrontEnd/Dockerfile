# Node.js 20 ë²„ì „ ê¸°ë°˜ìœ¼ë¡œ ë¹Œë“œ
FROM node:20.10.0 AS build
WORKDIR /app

# íŒ¨í‚¤ì§€ ê´€ë ¨ íŒŒì¼ ë³µì‚¬ ë° ì„¤ì •
COPY package.json yarn.lock ./

# Corepack í™œì„±í™” ë° Yarn ìµœì‹  ë²„ì „ ì ìš©
RUN corepack enable
RUN yarn set version berry  # ğŸ”¥ Yarn Berry(PnP) ë°©ì‹ ìœ ì§€

# PnP ë°©ì‹ ê°•ì œ ì„¤ì •
RUN yarn config set nodeLinker pnp

# í”„ë¡œì íŠ¸ ì½”ë“œ ë³µì‚¬ í›„ ì˜ì¡´ì„± ì„¤ì¹˜
COPY . .


# `.pnp.cjs`ê°€ ì •ìƒ ìƒì„±ë˜ë„ë¡ `yarn install`
RUN yarn install --immutable

# `.pnp.cjs` íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì—†ìœ¼ë©´ ë¹Œë“œ ì¤‘ë‹¨)
RUN test -f /app/.pnp.cjs || { echo "âŒ .pnp.cjs íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤! ë¹Œë“œë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."; exit 1; }


# TypeScript íŒ¨í‚¤ì§€ í™•ì¸ (ì—†ìœ¼ë©´ ì„¤ì¹˜)
RUN yarn why typescript || yarn add --dev typescript

# ê¸°ì¡´ Vite ì„¤ì • ìœ ì§€í•˜ë©´ì„œ `outDir: "dist"` ì¶”ê°€
RUN echo 'import { defineConfig } from "vite"; import react from "@vitejs/plugin-react"; export default defineConfig({ plugins: [react()], build: { outDir: "dist", emptyOutDir: true } });' > vite.config.ts


# TypeScript ì˜¤ë¥˜ ë¬´ì‹œí•˜ë©´ì„œ ë¹Œë“œ ì§„í–‰ (ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨)
RUN yarn build --skipLibCheck --noEmitOnError false

# ğŸ” ë¹Œë“œ ê²°ê³¼ í™•ì¸ (ë””ë²„ê¹…)
RUN ls -al /app/ && ls -al /app/dist/ || echo "âš ï¸ ë¹Œë“œëœ dist í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"

# 7ï¸âƒ£ Nginxê°€ ì‚¬ìš©í•  ë¹Œë“œ ë””ë ‰í† ë¦¬ ì„¤ì • (Nginx ì„¤ì •ê³¼ ì¼ì¹˜!)
RUN mkdir -p /home/ubuntu/frontend_build
RUN cp -r /app/dist/* /home/ubuntu/frontend_build

# 8ï¸âƒ£ Nginx ì»¨í…Œì´ë„ˆì—ì„œ ì‚¬ìš©í•  ë¹Œë“œ í´ë” ì§€ì •
VOLUME /home/ubuntu/frontend_build
